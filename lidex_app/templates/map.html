<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/examples/resources/layout.css" type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ol3/4.6.5/ol.css" />
    <link rel="stylesheet" href="https://unpkg.com/ol-popup@2.0.0/src/ol-popup.css">
    <!-- ol-ext -->
    <link rel="stylesheet" href="https://cdn.rawgit.com/Viglino/ol-ext/master/dist/ol-ext.min.css" />
    <style id=theStyleElement>



      .ol-dragbox {
        border-color: blue;
      }

      .fullscreen:-moz-full-screen {
        height: 100%;
      }
      .fullscreen:-webkit-full-screen {
        height: 100%;
      }
      .fullscreen:-ms-fullscreen {
        height: 100%;
      }

      .fullscreen:fullscreen {
        height: 100%;
      }

      .html .body .map .fullscreen {
        margin-bottom: 10px;
        width: 100%;
        height: 100%;
      }

      .ol-rotate {
        top: 3em;
      }

      .map {
        width: 80%;
        height: 100%;
        float: left;
      }

      .sidepanel {
        background: #1F6B75;
        width: 20%;
        height: 100%;
        float: left;
        padding: 10px;
        display: grid;
        grid-template-rows: auto 1fr auto;
      }

      .sidepanel-title {
        width: 100%;
        font-size: 1.5em;
        color: #ffffff;
        display: block;
        text-align: left;
      }

      .sidepanel-subtitle {
        width: 100%;
        font-size: 1.1em;
        color: #ffffff;
        display: block;
        text-align: left;
      }

      .sidepanel-buttons {
        width: 100%;
        padding: 10px;
      }

      .sidepanel-buttons.checked {
        background-color: rgb(141, 140, 140);
      }

      .hidden {
        display: none;
      }

      .busy {
        width: 100%;
        height: 70px;
        background-image: url('https://remix.run/loading.gif');
        background-repeat: no-repeat;
        background-position: center;
        background-size: 45px;
      }

      .ol-attribution ul {
        font-size: 0.6em;
      }

      #profili_panel {
        width: 100%;
        min-height: 400px;
        font-size: 10px !important;
        background-color: beige;
        margin-top: 10px;
      }

      footer {
      }

      #opt1 ,#opt2 ~ *  {
        font-size: 10px !important;
      }

    </style>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/openlayers/4.6.5/ol-debug.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/Viglino/ol-ext/master/dist/ol-ext.min.js"></script>
    <!-- filesaver-js -->
    <script type="text/javascript" src="https://cdn.rawgit.com/eligrey/FileSaver.js/aa9f4e0e/FileSaver.min.js"></script>
    <script src="https://unpkg.com/ol-popup@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.2.1/proj4.js"></script>
    <script src="https://unpkg.com/@alenaksu/json-viewer@2.0.0/dist/json-viewer.bundle.js"></script>
  </head>
  <body>
    <div id="fullscreen" class="fullscreen">
      <div id="map" class="map"></div>
      <div class="sidepanel">
        <header>
          <span class="sidepanel-title">Comune di Padova</span>
          <span class="sidepanel-subtitle">Settore urbanistica e servizi catastali<br/></span>
          <span class="sidepanel-subtitle">Rilievo 2023 - DTM - DSM - LIDAR</span>
          <span class="sidepanel-subtitle"></span>
          <button class="sidepanel-buttons" id="disegna_profilo" checked="">Profili da DTM - DSM</button>
          <button class="sidepanel-buttons" id="seleziona_b" checked="">Point cloud da finestra</button>
          <button class="sidepanel-buttons" id="seleziona_p" checked="">Point cloud da poligono</button>
        </header>
        <article>
          <div class="busy hidden" id="busy"></div>
          <button class="sidepanel-buttons hidden" id="placeholder">placeholder</button>
        </article>
        <footer>
          <div class="" id="risultati">
            <button class="sidepanel-buttons hidden" id="download_profilo">Download profilo DXF</button>
            <json-viewer id="view"></json-viewer>
            <button class="sidepanel-buttons hidden" id="download">Download point cloud (.laz)</button>
            <button class="sidepanel-buttons hidden" id="modello">Visualizza modello</button>
            <button class="sidepanel-buttons hidden" id="licenza">Licenza d'uso CC BY 4.0 Deed</button>
          </div>
          <div id="profili_panel" class="profili hidden">
            <div id="opt1" class="options">
            </div>
            <div id="opt2" class="options">
            </div>
          </div>
        </footer>
      </div>
    </div>


    <script>
      var UTM32Extent = [719459.961,5024860.053, 733523.921,5038269.875];
      proj4.defs('EPSG:32632', '+proj=utm +zone=32 +datum=WGS84 +towgs84=128.8,17.85,0,0,0,0,0 +units=m +no_defs');
      var UTM32proj = new ol.proj.Projection({
          code: 'EPSG:32632',
          extent: [166021.44, 0.0, 833978.56, 9329005.18]
      });
      ol.proj.addProjection(UTM32proj);
    
      console.log(UTM32proj.getExtent())
      
      var risposta
      var pFeat
      var tileSizePixels = 256;
      var tileSizeMtrs = ol.extent.getWidth(UTM32proj.getExtent()) / tileSizePixels;
      var matrixIds = [];
      var resolutions = [];
      for (var i = 0; i <= 14; i++) {
        matrixIds[i] = i;
        resolutions[i] = tileSizeMtrs / Math.pow(2, i);
      }
      var tileGrid = new ol.tilegrid.WMTS({
        origin: ol.extent.getTopLeft(UTM32proj.getExtent()),
        resolutions: resolutions,
        matrixIds: matrixIds
      });

        var ETRS89Extent = [719459.961,5024860.053, 733523.921,5038269.875];
        proj4.defs('EPSG:25832', '+proj=utm +zone=32 +ellps=GRS80 +towgs84=128.8,17.85,0,0,0,0,0 +units=m +no_defs');
        var ETRS89proj = new ol.proj.Projection({
            code: 'EPSG:25832',
            extent: ETRS89Extent
        });
        ol.proj.addProjection(ETRS89proj);

      var vview = new ol.View({
        center: [725011, 5031711],
        zoom: 3,
        projection: UTM32proj,
      });

      const confine = { "type": "Feature", "properties": { "LAYER": 41, "INTERNO_PE": 0, "NOTE": null, "SUPER": 0.0, "SHAPE_AREA": 93292192.678000003, "SHAPE_LEN": 74777.523490799998 }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 719647.82, 5028698.83 ], [ 719966.99, 5029486.63 ], [ 720008.1, 5029554.01 ], [ 720061.54, 5029560.15 ], [ 720115.89, 5029602.62 ], [ 720204.97, 5029779.26 ], [ 720424.54, 5029842.56 ], [ 720516.27, 5029853.46 ], [ 720515.98, 5029898.59 ], [ 720367.62, 5030383.2 ], [ 720442.66, 5030411.43 ], [ 720500.4, 5030355.6 ], [ 720665.2, 5030302.88 ], [ 720702.0, 5030303.1 ], [ 720716.32, 5030321.96 ], [ 720663.3, 5030487.76 ], [ 720661.66, 5030545.41 ], [ 720641.91, 5030552.39 ], [ 720660.27, 5030590.1 ], [ 720706.71, 5030629.77 ], [ 720783.41, 5030646.5 ], [ 720766.98, 5030705.8 ], [ 720800.9, 5030717.5 ], [ 720802.71, 5030777.66 ], [ 720698.1, 5030805.73 ], [ 720737.66, 5030926.31 ], [ 720573.56, 5030926.39 ], [ 720568.96, 5031215.41 ], [ 720601.05, 5031228.95 ], [ 720616.22, 5031356.21 ], [ 720571.93, 5031547.0 ], [ 720801.74, 5031581.65 ], [ 720820.79, 5031600.5 ], [ 720906.47, 5031622.54 ], [ 720909.16, 5031641.61 ], [ 721009.88, 5031658.38 ], [ 721082.82, 5032201.03 ], [ 721109.94, 5033248.98 ], [ 721108.31, 5034570.31 ], [ 721128.87, 5034773.01 ], [ 721278.6, 5034736.92 ], [ 721235.92, 5034890.39 ], [ 721244.58, 5035031.63 ], [ 721224.18, 5035244.77 ], [ 721254.48, 5035933.75 ], [ 721245.46, 5036079.33 ], [ 721261.32, 5036201.44 ], [ 721241.24, 5036443.22 ], [ 721401.46, 5037145.48 ], [ 721423.59, 5037301.84 ], [ 721474.82, 5037451.9 ], [ 721763.15, 5037482.07 ], [ 721779.62, 5037427.55 ], [ 721831.13, 5037444.78 ], [ 721892.8, 5037347.63 ], [ 721987.84, 5037265.9 ], [ 721962.83, 5037243.66 ], [ 721964.32, 5037226.47 ], [ 722142.68, 5036988.73 ], [ 722165.52, 5036967.48 ], [ 722236.73, 5037020.01 ], [ 722289.94, 5036956.64 ], [ 722326.51, 5036962.38 ], [ 722381.15, 5036915.93 ], [ 722335.48, 5036883.27 ], [ 722410.64, 5036805.01 ], [ 722483.9, 5036776.11 ], [ 722533.23, 5036716.38 ], [ 722646.07, 5036779.73 ], [ 722601.5, 5036833.44 ], [ 722639.83, 5036862.4 ], [ 722638.77, 5036892.62 ], [ 722599.79, 5036890.66 ], [ 722598.54, 5036930.25 ], [ 722657.94, 5036945.39 ], [ 722672.54, 5036918.79 ], [ 722835.82, 5036993.53 ], [ 722806.02, 5037019.45 ], [ 722817.99, 5037123.7 ], [ 722950.5, 5037139.97 ], [ 723026.32, 5037374.78 ], [ 722960.09, 5037504.19 ], [ 723133.5, 5037585.35 ], [ 723293.48, 5037726.17 ], [ 723351.3, 5037667.88 ], [ 723369.21, 5037617.88 ], [ 723419.26, 5037593.58 ], [ 723454.45, 5037604.21 ], [ 723477.94, 5037583.99 ], [ 723462.11, 5037544.52 ], [ 723471.51, 5037530.2 ], [ 723508.27, 5037542.52 ], [ 723592.56, 5037511.59 ], [ 723598.19, 5037427.39 ], [ 723619.81, 5037378.1 ], [ 723661.28, 5037332.87 ], [ 723747.94, 5037292.15 ], [ 723930.68, 5037283.43 ], [ 724081.56, 5037334.49 ], [ 724230.22, 5037414.33 ], [ 724391.14, 5037436.87 ], [ 724983.43, 5037428.51 ], [ 725060.42, 5037421.6 ], [ 725181.6, 5037378.75 ], [ 725313.05, 5037303.41 ], [ 725601.24, 5036916.16 ], [ 725689.98, 5036820.93 ], [ 725749.75, 5036787.63 ], [ 725962.99, 5036729.42 ], [ 725980.07, 5036784.3 ], [ 725996.41, 5036780.3 ], [ 726108.57, 5036895.0 ], [ 726272.55, 5037141.05 ], [ 726363.01, 5037183.59 ], [ 726482.46, 5037163.48 ], [ 726459.79, 5036888.04 ], [ 726434.32, 5036772.07 ], [ 726433.33, 5036646.52 ], [ 726447.93, 5036616.79 ], [ 726681.83, 5036529.91 ], [ 726704.87, 5036619.18 ], [ 726830.08, 5036741.18 ], [ 726936.47, 5036801.72 ], [ 727014.14, 5036809.64 ], [ 727185.45, 5036790.37 ], [ 727406.77, 5036811.62 ], [ 727532.45, 5036784.68 ], [ 727570.06, 5036745.91 ], [ 727592.35, 5036691.08 ], [ 727583.7, 5036569.32 ], [ 727505.42, 5036416.4 ], [ 727286.52, 5036082.1 ], [ 727447.15, 5035966.15 ], [ 727532.94, 5035938.38 ], [ 727654.18, 5035937.88 ], [ 728072.4, 5036013.3 ], [ 728190.65, 5035994.05 ], [ 728303.71, 5035916.61 ], [ 728466.58, 5035760.77 ], [ 728569.13, 5035690.99 ], [ 728749.72, 5035682.98 ], [ 728959.81, 5035641.89 ], [ 729121.21, 5035633.39 ], [ 729242.0, 5035654.1 ], [ 729412.72, 5035725.93 ], [ 729552.81, 5035736.37 ], [ 729750.44, 5035676.3 ], [ 729936.32, 5035578.58 ], [ 730085.45, 5035460.9 ], [ 730366.92, 5035173.29 ], [ 730583.03, 5034999.61 ], [ 730746.74, 5034843.86 ], [ 730992.93, 5034571.26 ], [ 731097.6, 5034259.93 ], [ 731112.55, 5034162.51 ], [ 730949.45, 5034158.19 ], [ 730755.73, 5034112.24 ], [ 730667.88, 5034145.79 ], [ 730588.22, 5034217.37 ], [ 730503.08, 5034125.84 ], [ 730419.77, 5034188.16 ], [ 730359.73, 5034101.57 ], [ 730338.99, 5034106.84 ], [ 730175.71, 5033934.97 ], [ 730137.5, 5033869.52 ], [ 730118.52, 5033726.53 ], [ 730055.3, 5033737.76 ], [ 730006.81, 5033720.27 ], [ 729917.44, 5033738.84 ], [ 729836.39, 5033797.4 ], [ 729818.84, 5033697.91 ], [ 729829.9, 5033697.45 ], [ 729827.43, 5033552.14 ], [ 729793.8, 5033420.61 ], [ 729575.9, 5033494.54 ], [ 729559.78, 5033309.5 ], [ 729602.22, 5033329.92 ], [ 729632.33, 5033305.59 ], [ 729640.96, 5033335.92 ], [ 729658.11, 5033334.37 ], [ 729720.0, 5033319.73 ], [ 729720.61, 5033271.95 ], [ 729899.87, 5033239.38 ], [ 729806.48, 5032924.09 ], [ 729785.74, 5032908.46 ], [ 729689.7, 5032346.57 ], [ 729508.72, 5032332.83 ], [ 729449.55, 5032059.44 ], [ 729719.36, 5031984.8 ], [ 729951.76, 5031966.13 ], [ 729992.72, 5031988.45 ], [ 730031.45, 5032050.66 ], [ 730142.27, 5032163.57 ], [ 730287.08, 5032195.71 ], [ 730353.01, 5032180.77 ], [ 730372.01, 5032197.84 ], [ 730462.96, 5032159.88 ], [ 730441.64, 5032105.68 ], [ 730751.48, 5031983.14 ], [ 730756.71, 5031937.8 ], [ 730804.09, 5031941.82 ], [ 730829.38, 5032139.23 ], [ 730903.13, 5032125.1 ], [ 730926.55, 5032181.26 ], [ 731293.84, 5032110.12 ], [ 731385.29, 5032068.22 ], [ 731475.89, 5032060.66 ], [ 731549.49, 5032034.77 ], [ 731600.08, 5032173.52 ], [ 731671.44, 5032149.63 ], [ 731685.9, 5032199.21 ], [ 731887.54, 5032294.06 ], [ 731951.39, 5032311.33 ], [ 732294.8, 5032303.73 ], [ 732390.61, 5032264.79 ], [ 732428.4, 5032333.26 ], [ 732466.51, 5032353.0 ], [ 732481.95, 5032393.83 ], [ 732620.69, 5032367.57 ], [ 732595.42, 5032264.39 ], [ 732821.93, 5032176.92 ], [ 732934.21, 5032098.31 ], [ 732869.58, 5031845.07 ], [ 732728.94, 5031846.51 ], [ 732669.68, 5031329.53 ], [ 732335.86, 5031375.72 ], [ 731872.56, 5031476.38 ], [ 731829.07, 5031122.91 ], [ 731735.34, 5031136.63 ], [ 731767.61, 5030942.19 ], [ 731679.25, 5030953.09 ], [ 731702.17, 5030815.72 ], [ 731607.52, 5030805.68 ], [ 731632.32, 5030701.48 ], [ 731680.76, 5030707.04 ], [ 731697.02, 5030605.91 ], [ 731648.96, 5030599.52 ], [ 731661.61, 5030475.26 ], [ 731673.75, 5030478.23 ], [ 731687.16, 5030398.74 ], [ 731672.22, 5030379.74 ], [ 731681.09, 5030309.08 ], [ 731567.95, 5030239.46 ], [ 731681.95, 5030146.46 ], [ 731627.24, 5030029.45 ], [ 731643.06, 5030014.02 ], [ 731561.27, 5029788.56 ], [ 731520.39, 5029794.9 ], [ 731413.63, 5029249.83 ], [ 731376.2, 5029299.92 ], [ 731277.01, 5029108.65 ], [ 731384.76, 5029059.52 ], [ 731661.02, 5028987.5 ], [ 731718.87, 5028954.92 ], [ 731763.14, 5028872.64 ], [ 731700.6, 5028752.61 ], [ 731640.12, 5028488.88 ], [ 731570.93, 5028315.19 ], [ 731368.84, 5028295.02 ], [ 730942.67, 5028194.19 ], [ 730426.25, 5028348.79 ], [ 730491.6, 5028438.67 ], [ 730622.23, 5028807.88 ], [ 730499.68, 5028853.46 ], [ 730477.86, 5028741.47 ], [ 730395.03, 5028753.96 ], [ 730383.58, 5028635.19 ], [ 730353.83, 5028634.09 ], [ 730328.62, 5028404.72 ], [ 730247.69, 5028419.98 ], [ 730249.36, 5028504.58 ], [ 730135.64, 5028766.06 ], [ 729971.73, 5028716.72 ], [ 729891.95, 5028714.44 ], [ 729832.25, 5028656.35 ], [ 729855.62, 5028604.82 ], [ 729841.97, 5028526.33 ], [ 729781.89, 5028453.72 ], [ 729694.89, 5028386.11 ], [ 729556.79, 5028378.35 ], [ 729564.33, 5028621.7 ], [ 729512.67, 5028721.87 ], [ 729304.99, 5028924.6 ], [ 729063.53, 5028982.66 ], [ 728868.05, 5029160.29 ], [ 728846.07, 5029200.54 ], [ 728818.32, 5029359.77 ], [ 728758.98, 5029464.24 ], [ 728639.78, 5029522.58 ], [ 728540.65, 5029610.22 ], [ 728491.27, 5029631.41 ], [ 727969.93, 5029654.97 ], [ 727820.09, 5029420.11 ], [ 727786.48, 5029426.73 ], [ 727672.5, 5029240.6 ], [ 727641.03, 5029162.36 ], [ 727674.78, 5029143.06 ], [ 727561.49, 5028959.21 ], [ 727642.82, 5028922.59 ], [ 727737.53, 5028817.16 ], [ 727731.23, 5028797.7 ], [ 728056.5, 5028615.91 ], [ 728039.18, 5028592.27 ], [ 728190.52, 5028459.71 ], [ 728209.59, 5028348.46 ], [ 728178.01, 5028337.37 ], [ 728153.93, 5028188.12 ], [ 728101.26, 5028190.31 ], [ 728076.41, 5028032.58 ], [ 727989.97, 5028044.29 ], [ 727972.61, 5027893.41 ], [ 728148.26, 5027877.93 ], [ 728203.53, 5027859.65 ], [ 728176.98, 5027718.38 ], [ 727941.6, 5027766.17 ], [ 727717.16, 5027839.99 ], [ 727631.68, 5028014.6 ], [ 727593.14, 5028142.25 ], [ 727541.26, 5028153.77 ], [ 727348.61, 5028186.16 ], [ 727272.8, 5027758.58 ], [ 727219.59, 5027744.54 ], [ 727077.66, 5027814.26 ], [ 727022.86, 5027913.3 ], [ 726920.03, 5027948.04 ], [ 726716.7, 5027978.28 ], [ 726615.67, 5027615.35 ], [ 726637.93, 5027581.98 ], [ 726919.44, 5027510.9 ], [ 726857.69, 5027270.63 ], [ 727357.59, 5027178.67 ], [ 727324.51, 5026976.18 ], [ 727513.58, 5026914.95 ], [ 727623.62, 5026816.18 ], [ 727685.31, 5026704.46 ], [ 727748.98, 5026674.25 ], [ 727809.55, 5026696.36 ], [ 727841.89, 5026685.12 ], [ 727863.22, 5026669.04 ], [ 727833.35, 5026604.14 ], [ 727931.93, 5026519.21 ], [ 728050.91, 5026468.56 ], [ 728028.11, 5026341.38 ], [ 728150.67, 5026269.39 ], [ 728100.99, 5026153.6 ], [ 728149.72, 5026138.21 ], [ 728053.05, 5025974.85 ], [ 728155.53, 5025949.6 ], [ 728131.6, 5025846.7 ], [ 728298.35, 5025854.39 ], [ 728392.28, 5025817.98 ], [ 728395.42, 5025804.34 ], [ 728357.7, 5025775.09 ], [ 728388.09, 5025743.77 ], [ 728382.46, 5025596.83 ], [ 728693.16, 5025531.26 ], [ 728794.13, 5024823.11 ], [ 728533.83, 5024894.55 ], [ 727564.43, 5025103.27 ], [ 727176.15, 5025154.16 ], [ 727192.09, 5025276.61 ], [ 727175.69, 5025341.71 ], [ 727203.67, 5025446.1 ], [ 727179.09, 5025512.81 ], [ 727067.06, 5025537.44 ], [ 726787.34, 5025419.95 ], [ 726703.55, 5025438.81 ], [ 726806.5, 5025893.76 ], [ 726862.27, 5026092.01 ], [ 726885.54, 5026097.03 ], [ 726915.05, 5026214.19 ], [ 726877.74, 5026220.64 ], [ 726736.05, 5026192.01 ], [ 726688.63, 5026200.7 ], [ 726637.33, 5026300.1 ], [ 726568.48, 5026286.89 ], [ 726531.56, 5026312.68 ], [ 726485.74, 5026063.77 ], [ 726421.78, 5026004.38 ], [ 726372.92, 5026019.28 ], [ 726277.0, 5026088.57 ], [ 726253.81, 5026077.87 ], [ 726213.96, 5025994.25 ], [ 726171.67, 5025974.87 ], [ 726051.17, 5025958.85 ], [ 725992.81, 5025975.07 ], [ 725923.57, 5026016.44 ], [ 725785.92, 5026163.07 ], [ 725732.26, 5026323.1 ], [ 725740.79, 5026348.21 ], [ 725631.22, 5026412.93 ], [ 725548.36, 5026423.83 ], [ 725484.36, 5026386.86 ], [ 725425.13, 5026315.66 ], [ 725399.13, 5026312.37 ], [ 725329.81, 5026343.17 ], [ 725348.91, 5026379.66 ], [ 725238.58, 5026413.7 ], [ 725296.41, 5026569.49 ], [ 725284.95, 5026588.74 ], [ 725249.06, 5026579.75 ], [ 725149.13, 5026606.57 ], [ 725049.92, 5026612.84 ], [ 725032.57, 5026631.09 ], [ 725033.49, 5026686.63 ], [ 725001.31, 5026709.49 ], [ 724966.55, 5026698.91 ], [ 724898.98, 5026625.42 ], [ 724771.02, 5026626.63 ], [ 724814.68, 5027063.75 ], [ 724210.43, 5027211.13 ], [ 724124.19, 5027240.8 ], [ 724074.57, 5027284.78 ], [ 724318.84, 5027757.08 ], [ 724080.07, 5027816.85 ], [ 724051.96, 5027838.38 ], [ 723979.51, 5027988.39 ], [ 723935.38, 5028153.76 ], [ 724055.43, 5028417.61 ], [ 724128.27, 5028407.76 ], [ 724168.31, 5028622.39 ], [ 724227.9, 5028794.78 ], [ 724215.68, 5028874.42 ], [ 724250.83, 5029073.05 ], [ 724244.84, 5029085.33 ], [ 724173.72, 5029092.91 ], [ 724113.04, 5029079.12 ], [ 724113.67, 5029193.5 ], [ 724046.58, 5029193.73 ], [ 724035.37, 5029360.81 ], [ 723984.29, 5029361.56 ], [ 723990.36, 5029580.51 ], [ 723853.73, 5029489.91 ], [ 723757.84, 5029386.64 ], [ 723471.91, 5029134.62 ], [ 723261.81, 5028883.42 ], [ 723172.09, 5028745.78 ], [ 722703.86, 5027843.92 ], [ 722453.56, 5027146.59 ], [ 722202.61, 5026545.62 ], [ 721960.6, 5026621.05 ], [ 721672.94, 5026836.85 ], [ 721610.06, 5026951.72 ], [ 721557.84, 5027104.06 ], [ 721431.43, 5027221.46 ], [ 721354.44, 5027238.49 ], [ 721218.76, 5027353.81 ], [ 721145.53, 5027371.41 ], [ 721084.13, 5027333.01 ], [ 720890.41, 5027422.57 ], [ 720811.38, 5027430.43 ], [ 720776.46, 5027459.25 ], [ 720589.05, 5027537.78 ], [ 720557.17, 5027576.09 ], [ 720541.91, 5027690.64 ], [ 720476.22, 5027750.63 ], [ 720412.77, 5027783.3 ], [ 720346.29, 5027866.81 ], [ 720196.8, 5027874.12 ], [ 720057.58, 5027977.71 ], [ 720024.74, 5027950.05 ], [ 719974.82, 5028043.79 ], [ 719964.12, 5028109.63 ], [ 720014.06, 5028361.82 ], [ 720052.76, 5028469.54 ], [ 720034.99, 5028490.14 ], [ 719989.02, 5028501.5 ], [ 719915.19, 5028588.05 ], [ 719647.82, 5028698.83 ] ] ] ] } }

      var testFeats = new ol.Collection( 
          [new ol.format.GeoJSON().readFeature(
            confine,
            {dataProjection:UTM32proj, featureProjection: UTM32proj},
            )
          ]
        )

      var boundOverlay = new ol.layer.Vector({
        source: new ol.source.Vector({
          features: testFeats,
          projection: UTM32proj,
        }),
        title: 'contesto test',
        visible: true,
        style: new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: '#FFA500',
            width: 3,
          }),
        }),
      });
      

      var selectionOverlay = new ol.layer.Vector({
        source: new ol.source.Vector(),
        title: 'selezione',
        visible: true,
        style: new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: '#0044FF',
            width: 3,
          }),
          fill: new ol.style.Fill({
            color: 'rgba(255, 255, 255, 0.2)'
          }),
          image: new ol.style.Circle({
            radius: 4,
            fill: new ol.style.Fill({
              color: '#0044FF'
            })
          })
        }),
      });
      
      var osm = new ol.layer.Tile({
        title: 'Openstreetmap',
        source: new ol.source.OSM(),
        baseLayer: true,
        visible: false,
      })

      var dragBox = new ol.interaction.DragBox({
      })

      dragBox.on('boxstart', function() {
        selectionOverlay.getSource().clear()
        document.getElementById("download").classList.add("hidden")
        document.getElementById("modello").classList.add("hidden")
      })

      dragBox.on('boxdrag', function() {
        const extent = dragBox.getGeometry().getExtent();
        let area = Math.abs(extent[2]-extent[0])*Math.abs(extent[3]-extent[1])
        if (area*20 > 2000000) {
          document.getElementById("theStyleElement").sheet.rules[0].style["border-color"] = 'red'
        } else {
          document.getElementById("theStyleElement").sheet.rules[0].style["border-color"] = 'blue'
        }
        console.log(area*20)
      })
      
      dragBox.on('boxend', function() {
        // features that intersect the box are added to the collection of
        // selected features
        if (document.getElementById("theStyleElement").sheet.rules[0].style["border-color"] == 'blue') {
          const extent = dragBox.getGeometry().getExtent();
          const feature = new ol.Feature({
            geometry: dragBox.getGeometry(),
            name: 'Selection',
          });
          selectionOverlay.getSource().addFeature(feature)
          console.log(extent)
          var xmlhttp = new XMLHttpRequest();   // new HttpRequest instance 
          xmlhttp.open("POST", "/punti/");
          xmlhttp.setRequestHeader("Content-Type", "application/json");
          xmlhttp.onreadystatechange = function () {
              console.log("RISPOSTA")
              if (this.readyState == 4) {
                //var blob = new Blob([this.response], { type: "application/octet-stream" });
                //saveAs(blob, "filename.zip");
                console.log(this.response)
                risposta = JSON.parse(this.response)
                if ( !risposta.error ) {
                  document.getElementById("seleziona_b").click()
                  document.getElementById("download").classList.remove("hidden")
                  document.getElementById("modello").classList.remove("hidden")
                  document.getElementById("licenza").classList.remove("hidden")
                  document.getElementById("view").classList.remove("hidden");
                  document.querySelector('#view').data = {info:risposta.info}
                } else {
                  selectionOverlay.getSource().clear()
                }
                document.getElementById("busy").classList.add("hidden")
              }
          };
        
          document.getElementById("busy").classList.remove("hidden")
          xmlhttp.send(JSON.stringify({extent:extent,geom:undefined}));
        }
      });

      var selectionColor = 'blue'

      var drawPolygon = new ol.interaction.Draw({
        //source: selectionOverlay,
        type: 'Polygon',
        source: undefined,
        style: function styleFunction (feature) {
          return new ol.style.Style({
              stroke: new ol.style.Stroke({
                color: selectionColor,
                width: 3
              }),
              fill: new ol.style.Fill({
                color: 'rgba(255, 255, 255, 0.2)'
              })
          })
        },
        geometryFunction: function(coordinates, geometry) {
          //coordinates.push(coordinates[0])
          //if ( coordinates[0][0][0] !== coordinates[0][coordinates.length][0] ) {
          //  coordinates[0].push(coordinates[0][0])
          //}
          if (coordinates[0].length > 2 ) {
            controlCoords = JSON.parse(JSON.stringify(coordinates))
            if ( controlCoords[0][0][0] !== controlCoords[0][controlCoords.length][0] ) {
              controlCoords[0].push(controlCoords[0][0])
            }
            console.log(controlCoords[0])
            const controlGeom = new ol.geom.Polygon(null,'XY')
            controlGeom.setCoordinates(controlCoords)
            let area = controlGeom.getArea()
            if (area*20 > 2000000) {
              selectionColor = 'red'
            } else {
              selectionColor = 'blue'
            }
            console.log(area*20)
          }
          
          if (!geometry) {
            geometry = new ol.geom.LineString(null);
          }
          console.info(coordinates);
          geometry.setCoordinates(coordinates);
          return geometry
        }
      })

      drawPolygon.on('drawstart', function() {
        selectionOverlay.getSource().clear()
        pFeat = undefined
        document.getElementById("download").classList.add("hidden")
        document.getElementById("modello").classList.add("hidden")
      })

      drawPolygon.on('change', function(event) {
        console.log(event)
      })
      
      drawPolygon.on('drawend', function(event) {
        // features that intersect the box are added to the collection of
        // selected features
        console.log(event.feature)
        if (selectionColor == 'blue') {
          let geom = event.feature.getGeometry()
          let coords = geom.getCoordinates()
          let ring = coords[0]
          console.log("EQUALITY", ring[0],ring[ring.length-1][0], ring[0][0] !== ring[ring.length-1][0])
          if (ring[0][0] !== ring[ring.length-1][0]) {
            ring.push(ring[0]) 
            coords =[ring]
          }
          const pgeom = new ol.geom.Polygon(coords)
          let converter = new ol.format.WKT()
          const wktgeom = converter.writeGeometry(pgeom);
          console.log(wktgeom)
          pFeat = new ol.Feature(pgeom)
          window.selectionOverlay.getSource().addFeature(pFeat)
          var xmlhttp = new XMLHttpRequest();   // new HttpRequest instance 
          xmlhttp.open("POST", "/punti/");
          xmlhttp.setRequestHeader("Content-Type", "application/json");
          xmlhttp.onreadystatechange = function () {
              console.log("RISPOSTA")
              if (this.readyState == 4) {
                //var blob = new Blob([this.response], { type: "application/octet-stream" });
                //saveAs(blob, "filename.zip");
                console.log(this.response)
                risposta = JSON.parse(this.response)
                if ( !risposta.error ) {
                  document.getElementById("seleziona_p").click()
                  document.getElementById("download").classList.remove("hidden")
                  document.getElementById("modello").classList.remove("hidden")
                  document.getElementById("licenza").classList.remove("hidden")
                  document.getElementById("view").classList.remove("hidden");
                  document.querySelector('#view').data = {info:risposta.info}

                } else {
                  selectionOverlay.getSource().clear()
                }
                document.getElementById("busy").classList.add("hidden")
              }
          };
        
          document.getElementById("busy").classList.remove("hidden")
          xmlhttp.send(JSON.stringify({extent:undefined,geom:wktgeom}));
        }
      });

      var drawLine = new ol.interaction.Draw({
        //source: selectionOverlay,
        type: 'LineString',
        maxPoints: 2,
        style: function styleFunction (feature) {
          return new ol.style.Style({
              stroke: new ol.style.Stroke({
                color: selectionColor,
                width: 5
              })
          })
        },
      })

      drawLine.on('drawstart', function() {
        selectionOverlay.getSource().clear()
        document.getElementById("download_profilo").classList.add("hidden")
      })

      drawLine.on('drawend', function(event) {
        let geom = event.feature.getGeometry()
        let coords = geom.getCoordinates()
        console.log(coords)
        var xmlhttp = new XMLHttpRequest();   // new HttpRequest instance 
        xmlhttp.open("POST", "/profilo/dtm/");
        xmlhttp.setRequestHeader("Content-Type", "application/json");
        xmlhttp.onreadystatechange = function () {
            console.log("RISPOSTA")
            if (this.readyState == 4) {
              //var blob = new Blob([this.response], { type: "application/octet-stream" });
              //saveAs(blob, "filename.zip");
              console.log(this.response)
              risposta = JSON.parse(this.response)
              if ( !risposta.error ) {
                document.getElementById("disegna_profilo").click()
                document.getElementById("download_profilo").classList.remove("hidden")
                document.getElementById("profili_panel").classList.remove("hidden")
                document.getElementById("licenza").classList.remove("hidden")

                window.selectionOverlay.getSource().clear()
                let converter = new ol.format.WKT()
                let dtmfeat = converter.readFeature(risposta.output.dtm.wkt)
                let dsmfeat = converter.readFeature(risposta.output.dsm.wkt)
                feature = dtmfeat
                window.selectionOverlay.getSource().addFeature(dtmfeat)
                profil.setGeometry(dtmfeat, {
                  graduation:50,
                  zmin:0
                });
                profil2.setGeometry(dsmfeat, {
                  graduation:50,
                  zmin:0
                });
                pt = new ol.Feature(new ol.geom.Point([0,0]));
                pt.setStyle([]);
                window.selectionOverlay.getSource().addFeature(pt);
              } else {
                selectionOverlay.getSource().clear()
              }
              document.getElementById("busy").classList.add("hidden")
            }
        };
      
        document.getElementById("busy").classList.remove("hidden")
        xmlhttp.send(JSON.stringify({line:coords}));

      })

      var map = new ol.Map({
        controls: ol.control.defaults().extend([
            new ol.control.MousePosition(),
        ]),
        layers: [
            osm,
        ],
        target: 'map',
        view: vview
      });

      map.getView().fit(UTM32Extent, map.getSize());

      map.addControl(new ol.control.LayerPopup())

      var profil = new ol.control.Profil({
        target: document.getElementById("opt1"),
        selectable: true,
        zoomable: true,
        style: new ol.style.Style({
          fill: new ol.style.Fill({ color: '#ccc' })
        }),
        title:"DTM",
        width:300, height:150
      });

      var profil2 = new ol.control.Profil({
        target: document.getElementById("opt2"),
        selectable: true,
        zoomable: true,
        style: new ol.style.Style({
          fill: new ol.style.Fill({ color: '#ccc' })
        }),
        title:"DSM",
        width:300, height:150
      });

      map.addControl(profil);
      map.addControl(profil2);
      var pt, feature
      // Draw a point on the map when mouse fly over profil
      function drawPoint(e) {
          if (!pt) return;
          if (e.type=="over"){
            // Show point at coord
            pt.setGeometry(new ol.geom.Point(e.coord));
            pt.setStyle(null);
          } else {
            // hide point
            pt.setStyle([]);
          }
        };
        // Show a popup on over
        profil.on(["over","out"], function(e) {
          if (e.type=="over") profil.popup(e.coord[2]+" m");
          drawPoint(e);
          profil2.showAt(e.distance)
        });
        profil2.on(["over","out"], function(e) {
          if (e.type=="over") profil.popup(e.coord[2]+" m");
          drawPoint(e);
          profil.showAt(e.distance)
        });

        var hover = new ol.interaction.Hover({ 
          cursor: "pointer", 
          hitTolerance:10,
          layers:[selectionOverlay]
        });
        map.addInteraction(hover);
        hover.on("hover", function(e) {
          // Point on the line
          if (!feature) return
          var c = feature.getGeometry().getClosestPoint(e.coordinate)
          drawPoint({ type: "over", coord: c });
          // Show profil
          var p = profil.showAt(e.coordinate);
          profil.popup(p[2]+" m");
          profil2.showAt(e.coordinate);
        });
        hover.on("leave", function(e) {
          profil.popup();
          profil.showAt();
          profil2.showAt();
          drawPoint({});
        });

      const parser = new ol.format.WMTSCapabilities();

      fetch('http://s02.blomurbex.com/v02/WMTSService?usertoken=0ef1451624f1e268baf59b265c211f62&service=WMTS&request=GetCapabilities')
      .then(function (response) {
        return response.text();
      })
      .then(function (text) {
        const capabilities = parser.read(text);
        var ortofoto_2023_ortho = new ol.layer.Tile({
          title: 'Ortofoto 2023',
          visible: true,
          baseLayer: true,
          source: new ol.source.WMTS(ol.source.WMTS.optionsFromCapabilities(capabilities, {
            layer: 'BlomURBEX:ORTHO',
            matrixSet: 'EPSG:32632',
          }))
        })       

        var ortofoto_2023_east= new ol.layer.Tile({
          title: 'Ortofoto 2023 east',
          visible: false,
          baseLayer: true,
          source: new ol.source.WMTS(ol.source.WMTS.optionsFromCapabilities(capabilities, {
            layer: 'BlomURBEX:EAST',
            matrixSet: 'EPSG:32632',
          }))
        })

        var ortofoto_2023_north= new ol.layer.Tile({
          title: 'Ortofoto 2023 north',
          visible: false,
          baseLayer: true,
          source: new ol.source.WMTS(ol.source.WMTS.optionsFromCapabilities(capabilities, {
            layer: 'BlomURBEX:NORTH',
            matrixSet: 'EPSG:32632',
          }))
        })

        var ortofoto_2023_south= new ol.layer.Tile({
          title: 'Ortofoto 2023 south',
          visible: false,
          baseLayer: true,
          source: new ol.source.WMTS(ol.source.WMTS.optionsFromCapabilities(capabilities, {
            layer: 'BlomURBEX:SOUTH',
            matrixSet: 'EPSG:32632',
          }))
        })

        var ortofoto_2023_west= new ol.layer.Tile({
          title: 'Ortofoto 2023 west',
          visible: false,
          baseLayer: true,
          source: new ol.source.WMTS(ol.source.WMTS.optionsFromCapabilities(capabilities, {
            layer: 'BlomURBEX:WEST',
            matrixSet: 'EPSG:32632',
          }))
        })

        let attrib = ['<a href="https://creativecommons.org/licenses/by/4.0/deed.it" target="_blank">2023 Comune di Padova - Settore Urbanistica e servizi catastali</a>']
        ortofoto_2023_ortho.getSource().setAttributions(attrib) 
        ortofoto_2023_north.getSource().setAttributions(attrib)
        ortofoto_2023_east.getSource().setAttributions(attrib)
        ortofoto_2023_south.getSource().setAttributions(attrib)
        ortofoto_2023_west.getSource().setAttributions(attrib)

        map.addLayer(ortofoto_2023_ortho)
        map.addLayer(ortofoto_2023_north)
        map.addLayer(ortofoto_2023_east)
        map.addLayer(ortofoto_2023_south)
        map.addLayer(ortofoto_2023_west)
        map.addLayer(boundOverlay)
        map.addLayer(selectionOverlay)

      });

      document.getElementById("seleziona_b").addEventListener('click', function() {
        console.log('Button clicked');
        map.removeInteraction(drawPolygon)
        map.removeInteraction(drawLine)
        document.getElementById("seleziona_p").classList.remove("checked");
        document.getElementById("disegna_profilo").classList.remove("checked");
        document.getElementById("download_profilo").classList.add("hidden");
        document.getElementById("view").classList.add("hidden");
        document.getElementById("profili_panel").classList.add("hidden");
        document.getElementById("licenza").classList.add("hidden")
        if ( document.getElementById("seleziona_b").classList.contains("checked")) {
            map.removeInteraction(dragBox)
            document.getElementById("seleziona_b").classList.remove("checked");
        } else {
            map.addInteraction(dragBox)
            document.getElementById("seleziona_b").classList.add("checked");
        }
      });

      document.getElementById("seleziona_p").addEventListener('click', function() {
        console.log('Button clicked');
        map.removeInteraction(dragBox)
        map.removeInteraction(drawLine)
        document.getElementById("seleziona_b").classList.remove("checked");
        document.getElementById("disegna_profilo").classList.remove("checked");
        document.getElementById("download_profilo").classList.add("hidden");
        document.getElementById("view").classList.add("hidden");
        document.getElementById("profili_panel").classList.add("hidden");
        document.getElementById("licenza").classList.add("hidden")
        if ( document.getElementById("seleziona_p").classList.contains("checked")) {
            map.removeInteraction(drawPolygon)
            document.getElementById("seleziona_p").classList.remove("checked");
        } else {
            map.addInteraction(drawPolygon)
            document.getElementById("seleziona_p").classList.add("checked");
        }
      });

      document.getElementById("disegna_profilo").addEventListener('click', function() {
        console.log('Button clicked');
        map.removeInteraction(dragBox)
        map.removeInteraction(drawPolygon)
        document.getElementById("seleziona_p").classList.remove("checked");
        document.getElementById("seleziona_b").classList.remove("checked");
        document.getElementById("download").classList.add("hidden");
        document.getElementById("modello").classList.add("hidden");
        document.getElementById("view").classList.add("hidden");
        document.getElementById("licenza").classList.add("hidden")
        if ( document.getElementById("disegna_profilo").classList.contains("checked")) {
            map.removeInteraction(drawLine)
            document.getElementById("disegna_profilo").classList.remove("checked");
        } else {
            map.addInteraction(drawLine)
            document.getElementById("disegna_profilo").classList.add("checked");
        }
      });
      
      document.getElementById("download").addEventListener('click', function() {
        window.open(risposta.output_laz, '_blank');
      });
      
      document.getElementById("modello").addEventListener('click', function() {
        window.open(risposta.output_dir+"/model/index.html", '_blank');
      });
      
      document.getElementById("download_profilo").addEventListener('click', function() {
        window.open(risposta.dxf, '_blank');
      });
      
      document.getElementById("licenza").addEventListener('click', function() {
        window.open('https://creativecommons.org/licenses/by/4.0/deed.it', '_blank');
      });
    </script>
    
    
  </body>
</html>
